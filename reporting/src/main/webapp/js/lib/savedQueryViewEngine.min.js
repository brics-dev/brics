var SavedQueryViewEngine={},SQViewProcessor={savedQueryModel:null,sqView:null,initialize:function(){TemplateManager.initPartials(),this.sqView=new SavedQueryViewEngine.SavedQueryView,EventBus.on("sqe:destroy:all",this.destroy,this)},loadSavedQuery:function(){this.savedQueryModel=new SavedQueryViewEngine.SavedQuery;var a=$("#savedQueryData").text().replace(/%20/g," ").replace(/&quot;/g,'"').trim(),b=$.parseJSON(a);return this.savedQueryModel.load(b),this.sqView.model=this.savedQueryModel,this.savedQueryModel},render:function(){null===this.savedQueryModel&&this.initialize();var a=this.loadSavedQuery();this.sqView.render(a)},destroy:function(){this.savedQueryModel=null,this.sqView=null}};SavedQueryViewEngine.SavedQuery=BaseModel.extend({studies:null,forms:null,defaults:{name:"",description:"",lastUpdated:"",formCount:0,linkedUsers:null,filtered:!1},load:function(a){this.studies=new SavedQueryViewEngine.SavedQueryStudies,this.forms=new SavedQueryViewEngine.SavedQueryForms,this.set("name",a.name),this.set("description",a.description),this.set("lastUpdated",a.lastUpdated),this.set("formCount",a.forms.length),this.set("linkedUsers",a.linkedUsers);for(var b=a.studies,c=a.forms,d=0;d<a.studies.length;d++){var e=new SavedQueryViewEngine.SavedQueryStudy;e.loadData(b[d]),this.studies.add(e)}for(var f=0;f<a.forms.length;f++){var g=new SavedQueryViewEngine.SavedQueryForm;g.loadData(c[f]),this.forms.add(g);for(var h=g.get("studyIds"),i=0;i<h.length;i++){var j=h[i],e=this.studies.getById(j);null!=e&&(e.addForm(g),e.set("formCount",e.get("formCount")+1),1==g.get("filtered")&&e.set("filtered",!0))}}this.studies.forEach(function(a){a.load()})}}),SavedQueryViewEngine.SavedQueryDe=BaseModel.extend({defaults:{uri:"",name:"",id:0,filtered:!1,maximum:"",minimum:"",freeFormValue:"",dateMin:"",dateMax:"",blank:"",permissibleValues:[]},addRg:function(a){this.savedQueryRgs.add(a)},loadData:function(a){this.set("uri",a.uri),this.set("name",a.name),this.set("id",a.id)},getRenderString:function(){var a="",b=this.get("maximum"),c=this.get("minimum"),d=this.get("freeFormValue"),e=this.get("dateMin"),f=this.get("dateMax"),g=this.get("blank"),h=this.get("permissibleValues");return a="",this.get("filtered")&&(""!=d?a+=' = "'+d+'"':""!=b&&""!=c?(""!=a&&(a+=" and "),a+=" between "+c+" and "+b):""!=e&&""!=f?(""!=a&&(a+=" and "),a+=" between "+e+" and "+f):""!=b?(""!=a&&(a+=" and "),a+=" < "+b):""!=c?(""!=a&&(a+=" and "),a+=" > "+c):""!=e?(""!=a&&(a+=" and "),a+=" after "+e):""!=f?(""!=a&&(a+=" and "),a+=" before "+f):h.length>0&&(""!=a&&(a+=" and "),a+=" one of "+h.join(", ")),g&&(""!=a&&(a+=" and "),a+=" including empty values")),a}}),SavedQueryViewEngine.SavedQueryDes=Backbone.Collection.extend({initialize:function(){this.model=SavedQueryViewEngine.SavedQueryDe},getById:function(a){return this.findWhere({id:a})},getByUri:function(a){return this.findWhere({uri:a})},getByName:function(a){return this.findWhere({name:a})}}),SavedQueryViewEngine.SavedQueryForm=BaseModel.extend({savedQueryRgs:null,defaults:{uri:"",name:"",id:0,filtered:!1,studyIds:[]},addRg:function(a){this.savedQueryRgs.add(a)},loadData:function(a){this.set("uri",a.uri),this.set("name",a.name),this.set("id",a.id),this.set("studyIds",a.studyIds),this.savedQueryRgs=new SavedQueryViewEngine.SavedQueryRgs;var b=a.groups;if(null!=b)for(var c=0;c<b.length;c++){var d=new SavedQueryViewEngine.SavedQueryRg;d.loadData(b[c]),this.addRg(d)}var e={filtered:!1,maximum:"",minimum:"",freeFormValue:"",dateMin:"",dateMax:"",blank:!1,permissibleValues:[]},f=a.filters;if(f.length>0){this.set("filtered",!0);for(var g=0;g<f.length;g++){var h=f[g],d=this.savedQueryRgs.getByUri(h.groupUri);if(null!=d){var i=d.savedQueryDes.getByUri(h.elementUri),j=_.clone(e);for(var k in h)j[k]=h[k];i.set(j)}}}}}),SavedQueryViewEngine.SavedQueryForms=Backbone.Collection.extend({initialize:function(){this.model=SavedQueryViewEngine.SavedQueryForm},getById:function(a){return this.findWhere({id:a})},getByName:function(a){return this.findWhere({name:a})},getByUri:function(a){return this.findWhere({uri:a})}}),SavedQueryViewEngine.SavedQueryRg=BaseModel.extend({savedQueryDes:null,defaults:{uri:"",name:"",id:0},addDe:function(a){this.savedQueryDes.add(a)},loadData:function(a){this.set("uri",a.uri),this.set("name",a.name),this.set("id",a.id),this.savedQueryDes=new SavedQueryViewEngine.SavedQueryDes;for(var b=a.elements,c=0;c<b.length;c++){var d=new SavedQueryViewEngine.SavedQueryDe;d.loadData(b[c]),this.addDe(d)}}}),SavedQueryViewEngine.SavedQueryRgs=Backbone.Collection.extend({initialize:function(){this.model=SavedQueryViewEngine.SavedQueryRg},getById:function(a){return this.findWhere({id:a})},getByUri:function(a){return this.findWhere({uri:a})},getByName:function(a){return this.findWhere({name:a})}}),SavedQueryViewEngine.SavedQueryStudy=BaseModel.extend({forms:null,defaults:{title:"",uri:"",formCount:0,id:0,active:!1},initialize:function(){this.forms=new SavedQueryViewEngine.SavedQueryForms,EventBus.on("sqe:change:activeStudy",this.checkActive,this)},loadData:function(a){this.set("title",a.title),this.set("uri",a.uri),this.set("id",a.id)},addForm:function(a){this.forms.add(a)},load:function(){},checkActive:function(a){var b=this.get("active");a.cid!=this.cid||b?a.cid!=this.cid&&b&&this.set("active",!1):this.set("active",!0)}}),SavedQueryViewEngine.SavedQueryStudies=Backbone.Collection.extend({initialize:function(){this.model=SavedQueryViewEngine.SavedQueryStudy},getById:function(a){return this.findWhere({id:a})}}),SavedQueryViewEngine.SavedQueryDeView=BaseView.extend({className:"viewQuery_deItem",initialize:function(){SavedQueryViewEngine.SavedQueryRgView.__super__.initialize.call(this),this.template=TemplateManager.getTemplate("deItem"),EventBus.on("sqe:close:all",this.destroy,this),EventBus.on("sqe:change:activeStudy",this.destroy,this),EventBus.on("sqe:destroy:all",this.destroy,this)},render:function(a){this.$el.html(this.template(this.model.attributes)),a.append(this.$el),this.model.get("filtered")?(this.$(".viewQuery_filterIcon").addClass("viewQuery_filtered"),this.$(".viewQuery_filterValue").text(this.model.getRenderString())):this.$(".viewQuery_filterIcon").addClass("viewQuery_nonFilered"),SavedQueryViewEngine.SavedQueryDeView.__super__.render.call(this)}}),SavedQueryViewEngine.SavedQueryRgView=BaseView.extend({className:"viewQuery_rgContainer",events:{},initialize:function(){SavedQueryViewEngine.SavedQueryRgView.__super__.initialize.call(this),this.template=TemplateManager.getTemplate("rgItem"),EventBus.on("sqe:close:all",this.destroy,this),EventBus.on("sqe:change:activeStudy",this.destroy,this),EventBus.on("sqe:destroy:all",this.destroy,this)},render:function(a){this.$el.html(this.template(this.model.attributes)),a.append(this.$el),SavedQueryViewEngine.SavedQueryRgView.__super__.render.call(this),this.renderDes()},renderDes:function(){var a=this.$(".viewQuery_deListContainer"),b=this.model.savedQueryDes;b.forEach(function(b){var c=new SavedQueryViewEngine.SavedQueryDeView({model:b});c.render(a)})}}),SavedQueryViewEngine.SavedQueryFormView=BaseView.extend({className:"viewQuery_formContainer",events:{"click .viewQuery_formHeader":"formClickHandler"},initialize:function(){SavedQueryViewEngine.SavedQueryFormView.__super__.initialize.call(this),this.template=TemplateManager.getTemplate("formItem"),EventBus.on("sqe:close:all",this.destroy,this),EventBus.on("sqe:change:activeStudy",this.destroy,this),EventBus.on("sqe:destroy:all",this.destroy,this)},render:function(a){this.$el.html(this.template(this.model.attributes)),a.append(this.$el),SavedQueryViewEngine.SavedQueryFormView.__super__.render.call(this),this.determineFiltered(),this.renderRgs()},formClickHandler:function(){var a=this.$(".viewQuery_formData");a.is(":visible")?(this.$(".viewQuery_plusMinus").text(" + ").removeClass("viewQuery_plus").addClass("viewQuery_minus"),a.hide()):(this.$(".viewQuery_plusMinus").text(" - ").removeClass("viewQuery_minus").addClass("viewQuery_plus"),a.show())},determineFiltered:function(){var a=this.$(".viewQuery_formFiltered");this.model.get("filtered")?a.show().addClass("viewQuery_filtered"):a.hide().addClass("viewQuery_nonFiltered")},renderRgs:function(){var a=this.$(".viewQuery_formData"),b=this.model.savedQueryRgs;b.length>0?b.forEach(function(b){var c=new SavedQueryViewEngine.SavedQueryRgView({model:b});c.render(a)}):a.text("There are no visible data elements in this form")}}),SavedQueryViewEngine.SavedQueryStudyView=BaseView.extend({className:"viewQuery_studyItem",events:{click:"studyClickHandler"},initialize:function(){SavedQueryViewEngine.SavedQueryStudyView.__super__.initialize.call(this),this.template=TemplateManager.getTemplate("study"),this.listenTo(this.model,"change:active",this.afterChangeActive),EventBus.on("sqe:close:all",this.destroy,this),EventBus.on("sqe:destroy:all",this.destroy,this)},render:function(a){this.$el.html(this.template(this.model.attributes)),a.append(this.$el),SavedQueryViewEngine.SavedQueryStudyView.__super__.render.call(this),this.determineFiltered()},studyClickHandler:function(){this.model.get("active")||EventBus.trigger("sqe:change:activeStudy",this.model)},determineFiltered:function(){var a=this.$(".viewQuery_studyFiltered");this.model.get("filtered")?a.show().addClass("viewQuery_filtered"):a.hide().addClass("viewQuery_nonFiltered")},afterChangeActive:function(){this.isActive()?(this.setActive(),this.updateFormHeader(),this.renderForms()):this.setInactive()},updateFormHeader:function(){var a=$(".viewQuery_formList"),b=$(".viewQuery_formCount"),c=this.model.get("formCount");0==c?(a.text("There are no forms in this saved query for this study"),b.text("")):(a.html(""),b.text("("+c+")"))},setActive:function(){this.$(".viewQuery_studyItemLink").addClass("viewQuery_active")},setInactive:function(){this.$(".viewQuery_studyItemLink").removeClass("viewQuery_active")},renderForms:function(){var a=this.model.forms,b=$(".viewQuery_formList");a.forEach(function(a){var c=new SavedQueryViewEngine.SavedQueryFormView({model:a});c.render(b)})},isActive:function(){return this.model.get("active")}}),SavedQueryViewEngine.SavedQueryView=BaseView.extend({events:{"click .viewQuery_queryHeader":"onOpenCloseQueryDetailsClick"},initialize:function(){SavedQueryViewEngine.SavedQueryView.__super__.initialize.call(this),this.template=TemplateManager.getTemplate("viewSavedQueryTemplate"),EventBus.on("sqe:close:all",this.close,this),EventBus.on("sqe:destroy:all",this.destroy,this)},render:function(a){EventBus.trigger("sqe:close:all"),this.$el.html(this.template(a.attributes)),$(".viewQueryContainer").append(this.$el);var b=a.studies,c=this.$(".viewQuery_studiesContainer");b.forEach(function(a){var b=new SavedQueryViewEngine.SavedQueryStudyView({model:a});b.render(c)})},onOpenCloseQueryDetailsClick:function(){var a=this.$(".viewQuery_queryDetails");a.is(":visible")?(this.$(".viewQuery_detailsPlusMinus").text(" + ").removeClass("viewQuery_plus").addClass("viewQuery_minus"),a.hide()):(this.$(".viewQuery_detailsPlusMinus").text(" - ").removeClass("viewQuery_minus").addClass("viewQuery_plus"),a.show())}});